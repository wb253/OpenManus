<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenManus Web</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>OpenManus ğŸ™‹</h1>
            <p class="subtitle">AIæ™ºèƒ½åŠ©æ‰‹ - ç½‘é¡µç‰ˆ</p>
        </header>

        <main>
            <div class="workspace">
                <div class="log-container">
                    <h2>å¤„ç†è¿›åº¦</h2>
                    <!-- è¿›åº¦æ¡å°†åœ¨JSä¸­åŠ¨æ€æ’å…¥ -->

                    <div class="thinking-header">
                        <h3>AIæ€è€ƒè¿‡ç¨‹</h3>
                    </div>
                    <div id="thinking-steps" class="thinking-steps"></div>

                    <!-- ç³»ç»Ÿæ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="system-logs" class="system-logs">
                        <div class="logs-header">
                            <h3>ç³»ç»Ÿæ—¥å¿—</h3>
                            <div class="logs-controls">
                                <button id="toggle-logs" class="toggle-btn">å±•å¼€/æŠ˜å </button>
                                <button id="clear-logs" class="clear-btn">æ¸…ç©º</button>
                            </div>
                        </div>
                        <div id="logs-content" class="logs-content"></div>
                    </div>

                    <!-- æ·»åŠ ç”Ÿæˆæ–‡ä»¶å®¹å™¨ -->
                    <div id="generated-files" class="generated-files">
                        <div class="files-header">
                            <h3>ç”Ÿæˆçš„æ–‡ä»¶</h3>
                            <p class="files-info">ç‚¹å‡»æ–‡ä»¶åæŸ¥çœ‹å†…å®¹</p>
                        </div>
                        <div id="files-list" class="files-list"></div>
                    </div>
                </div>

                <div class="chat-container">
                    <h2>å¯¹è¯</h2>
                    <div id="chat-messages" class="chat-messages"></div>

                    <div class="input-area">
                        <textarea id="user-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜æˆ–æŒ‡ä»¤..." rows="3"></textarea>
                        <div class="button-area">
                            <button id="send-btn" class="primary-btn">å‘é€</button>
                            <button id="stop-btn" class="stop-btn">åœæ­¢</button>
                            <button id="clear-btn" class="secondary-btn">æ¸…é™¤</button>
                        </div>
                    </div>

                    <!-- æ·»åŠ æ–‡ä»¶å†…å®¹æŸ¥çœ‹å™¨ -->
                    <div id="file-viewer" class="file-viewer">
                        <div class="file-viewer-header">
                            <h3 id="file-viewer-title">æ–‡ä»¶å†…å®¹</h3>
                            <button id="close-file-viewer" class="close-btn">Ã—</button>
                        </div>
                        <pre id="file-content" class="file-content"></pre>
                    </div>
                </div>
            </div>

            <div id="status-indicator" class="status-indicator"></div>
        </main>

        <!-- ç³»ç»Ÿæ—¥å¿—æ˜¾ç¤º -->
        <div class="section">
            <h2>ç³»ç»Ÿæ—¥å¿—</h2>
            <div class="log-list">
                <div class="log-header">
                    <span>æ–‡ä»¶å</span>
                    <span>æœ€åä¿®æ”¹æ—¶é—´</span>
                    <span>å¤§å°</span>
                    <span>æ“ä½œ</span>
                </div>
                <div id="logContent" class="log-content"></div>
            </div>
        </div>

        <!-- æ‰§è¡ŒçŠ¶æ€æ˜¾ç¤º -->
        <div class="section" id="execution-status-section">
            <h2>æ‰§è¡ŒçŠ¶æ€</h2>
            <div class="execution-status">
                <div class="status-header">
                    <h3 id="log-title">æœªé€‰æ‹©æ—¥å¿—æ–‡ä»¶</h3>
                    <div class="status-badge" id="status-badge">æœªçŸ¥</div>
                </div>

                <div class="progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="execution-progress-bar"></div>
                    </div>
                    <div class="progress-text" id="progress-text">0%</div>
                </div>

                <div class="execution-details">
                    <div class="detail-item">
                        <span class="detail-label">è®¡åˆ’ID:</span>
                        <span class="detail-value" id="plan-id">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å½“å‰æ­¥éª¤:</span>
                        <span class="detail-value" id="current-step">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">å®Œæˆæ­¥éª¤:</span>
                        <span class="detail-value" id="completed-steps">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">æ€»æ­¥éª¤æ•°:</span>
                        <span class="detail-value" id="total-steps">-</span>
                    </div>
                </div>

                <div class="steps-container">
                    <h4>æ‰§è¡Œæ­¥éª¤</h4>
                    <div class="steps-list" id="steps-list"></div>
                </div>

                <div class="tools-container">
                    <h4>å·¥å…·ä½¿ç”¨</h4>
                    <div class="tools-list" id="tools-list"></div>
                </div>

                <div class="errors-warnings-container">
                    <div class="errors-container">
                        <h4>é”™è¯¯ (<span id="errors-count">0</span>)</h4>
                        <div class="errors-list" id="errors-list"></div>
                    </div>
                    <div class="warnings-container">
                        <h4>è­¦å‘Š (<span id="warnings-count">0</span>)</h4>
                        <div class="warnings-list" id="warnings-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>Powered by OpenManus - <a href="https://github.com/mannaandpoem/OpenManus" target="_blank">GitHub</a></p>
        </footer>
    </div>

    <!-- <div class="system-logs-panel" id="systemLogsPanel">
        <h3>ç³»ç»Ÿæ—¥å¿—</h3>
        <div class="system-logs-container" id="systemLogsContainer">
            <p class="log-line">ç­‰å¾…æ—¥å¿—åŠ è½½...</p>
        </div>
    </div> -->

    <script src="{{ url_for('static', path='/script.js') }}"></script>
    <script>
        // æ–°å¢æ—¥å¿—åŠ è½½åŠŸèƒ½
        async function loadSystemLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();

                const logContent = document.getElementById('logContent');
                logContent.innerHTML = '';

                logs.logs.forEach(log => {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'log-entry';
                    logEntry.innerHTML = `
                        <span>${log.name}</span>
                        <span>${new Date(log.modified * 1000).toLocaleString()}</span>
                        <span>${(log.size/1024).toFixed(2)} KB</span>
                        <span class="log-actions">
                            <button class="view-log-btn" data-log="${log.name}">æŸ¥çœ‹å†…å®¹</button>
                            <button class="view-status-btn" data-log="${log.name}">æŸ¥çœ‹çŠ¶æ€</button>
                        </span>
                    `;
                    logContent.appendChild(logEntry);
                });

                // æ·»åŠ æŸ¥çœ‹æ—¥å¿—å†…å®¹æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.view-log-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const logName = e.target.getAttribute('data-log');
                        loadLogContent(logName);
                    });
                });

                // æ·»åŠ æŸ¥çœ‹æ‰§è¡ŒçŠ¶æ€æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.view-status-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const logName = e.target.getAttribute('data-log');
                        loadLogExecutionStatus(logName);
                    });
                });
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        async function loadLogContent(logName) {
            try {
                const response = await fetch(`/api/logs/${logName}`);
                const logData = await response.json();
                // åœ¨ç»ˆç«¯åŒºåŸŸæ˜¾ç¤ºæ—¥å¿—å†…å®¹
                if (document.getElementById('terminalOutput')) {
                    document.getElementById('terminalOutput').textContent = logData.content;
                } else {
                    // åˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ˜¾ç¤ºæ—¥å¿—å†…å®¹
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>æ—¥å¿—å†…å®¹: ${logName}</h3>
                                <span class="close-modal">&times;</span>
                            </div>
                            <div class="modal-body">
                                <pre>${logData.content}</pre>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // æ·»åŠ å…³é—­æŒ‰é’®äº‹ä»¶
                    modal.querySelector('.close-modal').addEventListener('click', () => {
                        document.body.removeChild(modal);
                    });

                    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading log content:', error);
            }
        }

        async function loadLogExecutionStatus(logName) {
            try {
                // æ˜¾ç¤ºæ‰§è¡ŒçŠ¶æ€åŒºåŸŸ
                document.getElementById('execution-status-section').style.display = 'block';

                // è·å–è§£æåçš„æ—¥å¿—ä¿¡æ¯
                const response = await fetch(`/api/logs_parsed/${logName}`);
                const logInfo = await response.json();

                // æ›´æ–°æ ‡é¢˜å’ŒçŠ¶æ€
                document.getElementById('log-title').textContent = `æ—¥å¿—: ${logName}`;

                // æ›´æ–°çŠ¶æ€å¾½ç« 
                const statusBadge = document.getElementById('status-badge');
                statusBadge.textContent = getStatusText(logInfo.status);
                statusBadge.className = `status-badge status-${logInfo.status}`;

                // æ›´æ–°è¿›åº¦æ¡
                const progressBar = document.getElementById('execution-progress-bar');
                const progressText = document.getElementById('progress-text');
                const percentage = logInfo.progress_percentage || 0;
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${percentage}%`;

                // æ›´æ–°è¯¦ç»†ä¿¡æ¯
                document.getElementById('plan-id').textContent = logInfo.plan_id || '-';
                document.getElementById('current-step').textContent = logInfo.current_step || '-';
                document.getElementById('completed-steps').textContent = logInfo.completed_steps || '0';
                document.getElementById('total-steps').textContent = logInfo.total_steps || '0';

                // æ›´æ–°æ­¥éª¤åˆ—è¡¨
                const stepsList = document.getElementById('steps-list');
                stepsList.innerHTML = '';

                if (logInfo.steps && logInfo.steps.length > 0) {
                    logInfo.steps.forEach((step, index) => {
                        const status = logInfo.step_statuses && logInfo.step_statuses[index]
                            ? logInfo.step_statuses[index]
                            : 'not_started';

                        const stepItem = document.createElement('div');
                        stepItem.className = `step-item step-${status}`;

                        let statusIcon = 'â¬œ';
                        if (status === 'completed') statusIcon = 'âœ…';
                        else if (status === 'in_progress') statusIcon = 'ğŸ”„';
                        else if (status === 'blocked') statusIcon = 'âš ï¸';

                        stepItem.innerHTML = `
                            <span class="step-status">${statusIcon}</span>
                            <span class="step-number">${index}.</span>
                            <span class="step-text">${step}</span>
                        `;

                        stepsList.appendChild(stepItem);
                    });
                } else {
                    stepsList.innerHTML = '<div class="no-steps">æ— æ­¥éª¤ä¿¡æ¯</div>';
                }

                // æ›´æ–°å·¥å…·ä½¿ç”¨åˆ—è¡¨
                const toolsList = document.getElementById('tools-list');
                toolsList.innerHTML = '';

                if (logInfo.tool_executions && logInfo.tool_executions.length > 0) {
                    logInfo.tool_executions.forEach(tool => {
                        const toolItem = document.createElement('div');
                        toolItem.className = 'tool-item';

                        if (tool.tool) {
                            toolItem.innerHTML = `
                                <span class="tool-icon">ğŸ”§</span>
                                <span class="tool-name">${tool.tool}</span>
                            `;
                        } else if (tool.action) {
                            toolItem.innerHTML = `
                                <span class="tool-icon">ğŸ”„</span>
                                <span class="tool-action">${tool.action}</span>
                            `;
                        }

                        toolsList.appendChild(toolItem);
                    });
                } else {
                    toolsList.innerHTML = '<div class="no-tools">æ— å·¥å…·ä½¿ç”¨è®°å½•</div>';
                }

                // æ›´æ–°é”™è¯¯åˆ—è¡¨
                const errorsList = document.getElementById('errors-list');
                errorsList.innerHTML = '';
                document.getElementById('errors-count').textContent = logInfo.errors ? logInfo.errors.length : '0';

                if (logInfo.errors && logInfo.errors.length > 0) {
                    logInfo.errors.forEach(error => {
                        const errorItem = document.createElement('div');
                        errorItem.className = 'error-item';
                        errorItem.innerHTML = `
                            <span class="error-icon">âŒ</span>
                            <span class="error-message">${error.message}</span>
                        `;
                        errorsList.appendChild(errorItem);
                    });
                } else {
                    errorsList.innerHTML = '<div class="no-errors">æ— é”™è¯¯</div>';
                }

                // æ›´æ–°è­¦å‘Šåˆ—è¡¨
                const warningsList = document.getElementById('warnings-list');
                warningsList.innerHTML = '';
                document.getElementById('warnings-count').textContent = logInfo.warnings ? logInfo.warnings.length : '0';

                if (logInfo.warnings && logInfo.warnings.length > 0) {
                    logInfo.warnings.forEach(warning => {
                        const warningItem = document.createElement('div');
                        warningItem.className = 'warning-item';
                        warningItem.innerHTML = `
                            <span class="warning-icon">âš ï¸</span>
                            <span class="warning-message">${warning.message}</span>
                        `;
                        warningsList.appendChild(warningItem);
                    });
                } else {
                    warningsList.innerHTML = '<div class="no-warnings">æ— è­¦å‘Š</div>';
                }

                // æ»šåŠ¨åˆ°æ‰§è¡ŒçŠ¶æ€åŒºåŸŸ
                document.getElementById('execution-status-section').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Error loading execution status:', error);
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            switch(status) {
                case 'completed': return 'å·²å®Œæˆ';
                case 'in_progress': return 'è¿›è¡Œä¸­';
                case 'error': return 'é”™è¯¯';
                case 'stopped': return 'å·²åœæ­¢';
                default: return 'æœªçŸ¥';
            }
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ—¥å¿—
        loadSystemLogs();

        // é»˜è®¤éšè—æ‰§è¡ŒçŠ¶æ€åŒºåŸŸ
        document.addEventListener('DOMContentLoaded', function() {
            const statusSection = document.getElementById('execution-status-section');
            if (statusSection) {
                statusSection.style.display = 'none';
            }
        });

        // åœ¨WebSocketè¿æ¥éƒ¨åˆ†æ·»åŠ å¤„ç†ç³»ç»Ÿæ—¥å¿—çš„é€»è¾‘
        const connectWebSocket = (sessionId) => {
            // ...existing code...

            // æ·»åŠ ä¸€ä¸ªå˜é‡è·Ÿè¸ªæœ€åä¸€æ¡ç³»ç»Ÿæ—¥å¿—æ¶ˆæ¯å…ƒç´ 
            let lastSystemLogMessage = null;
            let lastSystemLogTimestamp = 0;

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                // å¤„ç†ç³»ç»Ÿæ—¥å¿—æ›´æ–° - æ·»åŠ åˆ°ç³»ç»Ÿæ—¥å¿—é¢æ¿
                if (data.system_logs && data.system_logs.length > 0) {
                    const systemLogsContainer = document.getElementById('systemLogsContainer');
                    if (systemLogsContainer) {
                        // æ¸…ç©º"ç­‰å¾…åŠ è½½"æ¶ˆæ¯
                        if (systemLogsContainer.querySelector('p').textContent === 'ç­‰å¾…æ—¥å¿—åŠ è½½...') {
                            systemLogsContainer.innerHTML = '';
                        }

                        // æ·»åŠ æ–°æ—¥å¿—
                        data.system_logs.forEach(log => {
                            const logLine = document.createElement('p');
                            logLine.className = 'log-line';
                            logLine.textContent = log;
                            systemLogsContainer.appendChild(logLine);
                        });

                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        systemLogsContainer.scrollTop = systemLogsContainer.scrollHeight;
                    }

                    // å°†ç³»ç»Ÿæ—¥å¿—æ·»åŠ åˆ°å¯¹è¯çª—å£ä¸­ - ä¿®å¤ä»£ç 
                    const chatMessages = document.getElementById('chat-messages');
                    if (chatMessages) {
                        const now = Date.now();
                        // å¦‚æœè·ç¦»ä¸Šä¸€æ¡ç³»ç»Ÿæ—¥å¿—æ¶ˆæ¯ä¸è¶…è¿‡5ç§’ï¼Œåˆ™åˆå¹¶æ˜¾ç¤º
                        if (lastSystemLogMessage &&
                            lastSystemLogMessage.parentNode === chatMessages &&
                            now - lastSystemLogTimestamp < 5000) {

                            // è·å–å·²æœ‰çš„æ—¥å¿—å†…å®¹å…ƒç´ 
                            const logContent = lastSystemLogMessage.querySelector('.system-log-content');
                            if (logContent) {
                                // è¿½åŠ æ–°çš„æ—¥å¿—å†…å®¹
                                logContent.textContent += '\n' + data.system_logs.join('\n');

                                // æ›´æ–°æ—¶é—´æˆ³
                                lastSystemLogTimestamp = now;

                                // æ»šåŠ¨åˆ°åº•éƒ¨
                                chatMessages.scrollTop = chatMessages.scrollHeight;
                                return;
                            }
                        }

                        // åˆ›å»ºä¸€ä¸ªæ–°çš„OpenManuså›å¤æ¶ˆæ¯
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'message system-message';

                        // åˆ›å»ºæ¶ˆæ¯å¤´éƒ¨
                        const messageHeader = document.createElement('div');
                        messageHeader.className = 'message-header';
                        messageHeader.innerHTML = '<span class="avatar system">ğŸ¤–</span><span class="sender">OpenManus</span>';

                        // åˆ›å»ºæ¶ˆæ¯å†…å®¹
                        const messageContent = document.createElement('div');
                        messageContent.className = 'message-content log-message';

                        // æ·»åŠ æ—¥å¿—å†…å®¹
                        const logContent = document.createElement('pre');
                        logContent.className = 'system-log-content';
                        logContent.textContent = data.system_logs.join('\n');

                        // ç»„è£…æ¶ˆæ¯
                        messageContent.appendChild(logContent);
                        messageDiv.appendChild(messageHeader);
                        messageDiv.appendChild(messageContent);

                        // æ·»åŠ åˆ°å¯¹è¯çª—å£
                        chatMessages.appendChild(messageDiv);

                        // æ›´æ–°æœ€åçš„ç³»ç»Ÿæ—¥å¿—æ¶ˆæ¯å¼•ç”¨å’Œæ—¶é—´æˆ³
                        lastSystemLogMessage = messageDiv;
                        lastSystemLogTimestamp = now;

                        // æ»šåŠ¨åˆ°åº•éƒ¨
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }

                // ...existing code...
            };
            // ...existing code...
        };
    </script>

    <style>
        .system-logs-panel {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .system-logs-container {
            height: 300px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #ddd;
            font-family: monospace;
            padding: 10px;
            border-radius: 4px;
        }

        .log-line {
            margin: 0;
            padding: 2px 0;
            font-size: 14px;
            white-space: pre-wrap;
        }

        /* æ·»åŠ ç³»ç»Ÿæ—¥å¿—åœ¨å¯¹è¯çª—å£ä¸­çš„æ ·å¼ */
        .system-message .message-content {
            background-color: #f1f8ff;
            border-left: 4px solid #0366d6;
        }

        .system-log-content {
            margin: 0;
            padding: 8px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            color: #333;
            background-color: #f8f8f8;
            border-radius: 4px;
            overflow: auto;
            max-height: 300px;
        }
    </style>
</body>
</html>
